<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Panel Admin - Dashboard & Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic styling - clean & mobile friendly */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:12px;background:#f4f6f8;color:#222}
    .nav{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:#fff;border:1px solid #e0e6eb;cursor:pointer}
    .tab.active{background:#0b79f7;color:#fff;border-color:#0b79f7}
    .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 1px 6px rgba(0,0,0,0.06);margin-bottom:10px}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{padding:8px;border:1px solid #d0d6db;border-radius:6px}
    textarea{min-height:100px;width:100%;resize:vertical}
    .btn{padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
    .primary{background:#0b79f7;color:#fff}
    .danger{background:#e24b4b;color:#fff}
    .ghost{background:transparent;border:1px solid #d0d6db}
    .dashboard{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:900px){.dashboard{grid-template-columns:repeat(4,1fr)}}
    .dash-item{padding:10px}
    .dash-title{display:flex;justify-content:space-between;align-items:center}
    .count{font-weight:700;font-size:18px}
    .list-emails{margin-top:10px;padding-top:8px;border-top:1px dashed #e6e9ec;display:none}
    .email-row{padding:6px 0;border-bottom:1px solid #f1f3f5;display:flex;justify-content:space-between;align-items:center}
    .muted{color:#666;font-size:13px}
    .item-card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:10px}
    .small{font-size:13px;color:#555}
    .hidden{display:none}
  </style>
</head>
<body>

  <h2>Panel Admin</h2>

  <!-- Tabs -->
  <div class="nav">
    <div id="tabDashboard" class="tab active">Dashboard Status</div>
    <div id="tabAdmin" class="tab">Admin Panel</div>
  </div>

  <!-- Dashboard view -->
  <div id="viewDashboard">
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ringkasan Status</div>
      <div class="dashboard" id="dashboard"></div>
    </div>
  </div>

  <!-- Admin view -->
  <div id="viewAdmin" class="hidden">
    <div class="card">
      <div class="flex" style="align-items:center">
        <input id="email" type="email" placeholder="Email" style="flex:1" />
        <input id="wa" type="text" placeholder="No WA (085xxx atau +6285xxx)" style="width:160px" />
        <input id="tanggal" type="text" readonly style="width:180px" />
        <select id="statusSelect" style="width:140px">
          <option>New Acc</option><option>Unrestrict</option><option>Old Acc</option><option>Restric</option>
        </select>
        <button id="addBtn" class="btn primary">Tambah</button>
        <button id="resetFormBtn" class="btn ghost">Reset</button>
      </div>
      <div class="muted small" style="margin-top:6px">Note: WA otomatis disimpan dengan prefix <code>+62</code> bila diperlukan.</div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Kontrol Admin</div>
      <div class="flex" style="align-items:center">
        <input id="searchInput" placeholder="Cari email..." style="flex:1" />
        <button id="reloadBtn" class="btn ghost">Reload</button>
      </div>
      <div style="margin-top:10px">
        <div style="font-weight:700;margin-bottom:6px">Identifikasi Massal</div>
        <textarea id="bulkInput" placeholder="Tempel email (satu per baris)"></textarea>
        <div class="flex" style="margin-top:8px">
          <button id="identifyBtn" class="btn primary">Identifikasi</button>
          <select id="bulkStatusSelect" style="width:160px">
            <option>New Acc</option><option>Unrestrict</option><option>Old Acc</option><option>Restric</option>
          </select>
          <button id="bulkUpdateBtn" class="btn primary">Ubah Status Massal</button>
          <button id="bulkResetBtn" class="btn danger">Reset</button>
        </div>
        <div id="identifyResult" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="adminList"></div>
  </div>

<script>
/* ========== Konfigurasi JSONBin ========== */
const BIN_ID = "6905803fae596e708f3baa25";
const API_KEY = "$2a$10$ziNrwiYaAO5/AfgfNP218OKOtjLxTV6c7Zau9vLmygY35FQ36jlci";
const BASE = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* ========== DOM ========== */
const tabDashboard = document.getElementById('tabDashboard');
const tabAdmin = document.getElementById('tabAdmin');
const viewDashboard = document.getElementById('viewDashboard');
const viewAdmin = document.getElementById('viewAdmin');

const dashboardEl = document.getElementById('dashboard');

const emailEl = document.getElementById('email');
const waEl = document.getElementById('wa');
const tanggalEl = document.getElementById('tanggal');
const statusSelect = document.getElementById('statusSelect');
const addBtn = document.getElementById('addBtn');
const resetFormBtn = document.getElementById('resetFormBtn');

const searchInput = document.getElementById('searchInput');
const reloadBtn = document.getElementById('reloadBtn');

const bulkInput = document.getElementById('bulkInput');
const identifyBtn = document.getElementById('identifyBtn');
const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
const bulkResetBtn = document.getElementById('bulkResetBtn');
const bulkStatusSelect = document.getElementById('bulkStatusSelect');
const identifyResult = document.getElementById('identifyResult');

const adminList = document.getElementById('adminList');

/* ========== State ========== */
let dbData = [];            // cached data from JSONBin
let editingEmail = null;    // if editing (original email)

/* ========== Utilities ========== */
function formatTanggalNow(){
  return new Date().toLocaleDateString('id-ID',{ weekday:'long', day:'numeric', month:'long' });
}
tanggalEl.value = formatTanggalNow();

function normalizeWA(v){
  if(!v) return '';
  let s = String(v).trim().replace(/\s+/g,'');
  if(s.startsWith('+62')) return s;
  if(s.startsWith('0')) return '+62' + s.slice(1);
  if(s.startsWith('62')) return '+62' + s.slice(2);
  return '+62' + s;
}
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function decodeHtml(str){ const t=document.createElement('textarea'); t.innerHTML=str; return t.value; }

/* ========== Tab switching ========== */
tabDashboard.onclick = ()=>{ tabDashboard.classList.add('active'); tabAdmin.classList.remove('active'); viewDashboard.classList.remove('hidden'); viewAdmin.classList.add('hidden'); }
tabAdmin.onclick = ()=>{ tabAdmin.classList.add('active'); tabDashboard.classList.remove('active'); viewAdmin.classList.remove('hidden'); viewDashboard.classList.add('hidden'); }

/* ========== Fetch helpers ========== */
async function fetchLatest(){
  try{
    const res = await fetch(`${BASE}/latest`, { headers: { 'X-Master-Key': API_KEY }});
    const j = await res.json();
    return j.record || [];
  }catch(e){
    console.error('fetchLatest err', e);
    return [];
  }
}
async function putAll(arr){
  try{
    await fetch(BASE, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json', 'X-Master-Key': API_KEY },
      body: JSON.stringify(arr)
    });
  }catch(e){
    console.error('putAll err', e);
    alert('Gagal menyimpan. Cek console.');
  }
}

/* ========== Load & Render ========== */
async function loadAll(){
  dbData = await fetchLatest();
  if(!Array.isArray(dbData)) dbData = [];
  renderDashboard();
  renderAdminList();
  applySearch(); // keep search filter
}

function getWhatsAppField(item){
  return item.whatsapp || item.WhatsApp || item.wa || item.WA || '-';
}

function renderDashboard(){
  const keys = ['New Acc','Unrestrict','Old Acc','Restric'];
  // categorize
  const categories = {};
  keys.forEach(k=> categories[k] = []);
  dbData.forEach(it=>{
    const st = it.statusAcc || it.status || 'New Acc';
    const key = keys.includes(st) ? st : 'New Acc';
    categories[key].push(it);
  });

  // build cards
  dashboardEl.innerHTML = keys.map(key=>{
    const list = categories[key];
    const id = `list-${key.replace(/\s+/g,'')}`;
    return `
      <div class="card dash-item">
        <div class="dash-title">
          <div>
            <div style="font-weight:700">${escapeHtml(key)}</div>
            <div class="small muted">Total email</div>
          </div>
          <div style="text-align:right">
            <div class="count">${list.length}</div>
            <button class="btn ghost" data-target="${id}" aria-expanded="false">â‹®</button>
          </div>
        </div>
        <div id="${id}" class="list-emails">
          ${ list.length ? list.map(it=>`<div class="email-row"><div>${escapeHtml(it.email)}</div><div class="small muted">${escapeHtml(getWhatsAppField(it))}</div></div>`).join('') : `<div class="small muted" style="padding:6px 0">Tidak ada email</div>`}
        </div>
      </div>
    `;
  }).join('');

  // attach toggle handlers
  document.querySelectorAll('[data-target]').forEach(btn=>{
    const tgt = btn.getAttribute('data-target');
    btn.onclick = () => {
      const el = document.getElementById(tgt);
      if(!el) return;
      const isOpen = el.style.display === 'block';
      el.style.display = isOpen ? 'none' : 'block';
      btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
    };
  });
}

/* ========== Admin List (detailed) ========== */
function renderAdminList(){
  // sort by status order
  const order = ['New Acc','Unrestrict','Old Acc','Restric'];
  const sorted = [...dbData].sort((a,b)=> order.indexOf(a.statusAcc||a.status||'New Acc') - order.indexOf(b.statusAcc||b.status||'New Acc'));

  adminList.innerHTML = sorted.map(item=>{
    const wa = getWhatsAppField(item);
    const status = item.statusAcc || item.status || 'New Acc';
    const tanggal = item.tanggal || '-';
    const e = escapeHtml(item.email || '-');
    return `
      <div class="item-card card" data-email="${e}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${e}</div>
          <div>
            <button class="btn ghost" data-action="edit" data-email="${e}">Edit</button>
            <button class="btn danger" data-action="delete" data-email="${e}">Hapus</button>
          </div>
        </div>
        <div style="margin-top:8px" class="muted">
          <div>No WA: ${escapeHtml(wa)}</div>
          <div>Tanggal: ${escapeHtml(tanggal)}</div>
          <div>Status: ${escapeHtml(status)}</div>
        </div>
      </div>
    `;
  }).join('');

  // attach event handlers
  adminList.querySelectorAll('[data-action="edit"]').forEach(btn=>{
    btn.onclick = () => {
      const e = decodeHtml(btn.getAttribute('data-email'));
      startEdit(e);
    };
  });
  adminList.querySelectorAll('[data-action="delete"]').forEach(btn=>{
    btn.onclick = () => {
      const e = decodeHtml(btn.getAttribute('data-email'));
      deleteByEmail(e);
    };
  });
}

/* ========== Search / Filter ========== */
function applySearch(){
  const q = (searchInput.value || '').trim().toLowerCase();
  document.querySelectorAll('#adminList .item-card').forEach(card=>{
    const email = (card.getAttribute('data-email')||'').toLowerCase();
    card.style.display = email.includes(q) ? '' : 'none';
  });
  // dashboard expanded lists
  document.querySelectorAll('.list-emails .email-row').forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
}

/* ========== Add / Edit / Delete ========== */
addBtn.addEventListener('click', async ()=>{
  const email = (emailEl.value || '').trim().toLowerCase();
  if(!email) return alert('Isi email dulu');
  let wa = (waEl.value || '').trim();
  wa = wa ? normalizeWA(wa) : '';
  const tanggal = tanggalEl.value || formatTanggalNow();
  const status = statusSelect.value || 'New Acc';

  const latest = await fetchLatest();

  if(editingEmail){
    const idx = latest.findIndex(d => (d.email||'').toLowerCase() === (editingEmail||'').toLowerCase());
    if(idx === -1){
      alert('Data tidak ditemukan di server. Reloading.');
      editingEmail = null;
      return loadAll();
    }
    // prevent duplicate email if changed
    if(email.toLowerCase() !== editingEmail.toLowerCase() && latest.some((d,i)=>i!==idx && (d.email||'').toLowerCase() === email.toLowerCase())){
      return alert('Email sudah ada, tidak bisa mengganti ke email yang sama.');
    }
    // update: keep other fields if exist
    latest[idx] = { ...latest[idx], email, whatsapp: wa, tanggal, statusAcc: status };
    await putAll(latest);
    editingEmail = null;
    resetForm();
    return loadAll();
  }

  // add new
  if(latest.some(d => (d.email||'').toLowerCase() === email.toLowerCase())) return alert('Email sudah ada!');
  latest.push({ email, whatsapp: wa, tanggal, statusAcc: status });
  await putAll(latest);
  resetForm();
  loadAll();
});

function resetForm(){
  emailEl.value=''; waEl.value=''; statusSelect.value='New Acc'; editingEmail = null;
}
resetFormBtn.addEventListener('click', resetForm);

function startEdit(email){
  const item = dbData.find(d => (d.email||'').toLowerCase() === (email||'').toLowerCase());
  if(!item) return alert('Data tidak ditemukan.');
  emailEl.value = item.email || '';
  waEl.value = item.whatsapp || item.WhatsApp || '';
  statusSelect.value = item.statusAcc || item.status || 'New Acc';
  editingEmail = item.email;
  // switch to admin tab
  tabAdmin.click();
  window.scrollTo({ top:0, behavior:'smooth' });
}

async function deleteByEmail(email){
  if(!confirm(`Hapus ${email} ?`)) return;
  const latest = await fetchLatest();
  const idx = latest.findIndex(d => (d.email||'').toLowerCase() === (email||'').toLowerCase());
  if(idx === -1) return alert('Data tidak ditemukan (mungkin sudah dihapus).');
  latest.splice(idx,1);
  await putAll(latest);
  loadAll();
}

/* ========== Bulk identify & update ========== */
identifyBtn.addEventListener('click', async ()=>{
  const list = bulkInput.value.split(/\r?\n/).map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(!list.length) return alert('Masukkan email dulu');
  const latest = await fetchLatest();
  const allEmails = latest.map(d => (d.email||'').toLowerCase());
  const found = [], notfound = [];
  list.forEach(e => (allEmails.includes(e) ? found.push(e) : notfound.push(e)));
  identifyResult.innerHTML = `<div><strong>Ditemukan (${found.length}):</strong><br>${found.join('<br>')||'-'}</div>
                              <div style="margin-top:8px"><strong>Tidak ditemukan (${notfound.length}):</strong><br>${notfound.join('<br>')||'-'}</div>`;
});

bulkUpdateBtn.addEventListener('click', async ()=>{
  const list = bulkInput.value.split(/\r?\n/).map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(!list.length) return alert('Masukkan email yang akan diubah (satu per baris).');
  const newStatus = bulkStatusSelect.value || 'New Acc';
  const latest = await fetchLatest();
  let changed = 0;
  const updated = latest.map(d=>{
    if(list.includes((d.email||'').toLowerCase())){
      changed++;
      return { ...d, statusAcc: newStatus };
    }
    return d;
  });
  if(changed === 0) return alert('Tidak ada email yang cocok untuk diubah.');
  await putAll(updated);
  alert(`Status diubah untuk ${changed} email.`);
  loadAll();
});

bulkResetBtn.addEventListener('click', ()=>{
  bulkInput.value=''; identifyResult.innerHTML='';
});

/* ========== Misc handlers ========== */
reloadBtn.addEventListener('click', loadAll);
searchInput.addEventListener('input', applySearch);

/* ========== Initial load ========== */
loadAll();

</script>
</body>
</html>
